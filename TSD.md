# Technical Specification Document (TSD)

**Project:** Mobile App + Express Backend (Auth & Profile)
**Date:** 2025-09-03

---

## 1. Goals & Scope

### Goals

Deliver a minimal, production-ready full-stack slice consisting of:
*   Login (email + password)
*   Profile (view & update)
*   Change Password

### Scope
*   **Mobile Client:** One mobile app using Flutter consuming REST APIs.
*   **Backend:** Node.js Express (REST) with JWT authentication, connected to a relational DB (MySQL).
*   **Auth Model:** Email/password, access token (short-lived) + refresh token (long-lived).
*   **Profile Fields (minimal):** `name`, `jobTitle` (“jabatan”), `company`.

### Out of Scope
*   Registration/forgot password (optional stretch)
*   Social login (Google/Apple)
*   File upload (avatar)
*   Multi-role authorization and admin CMS

---

## 2. Success Criteria
*   User can log in with valid credentials and receive tokens.
*   User can view their profile.
*   User can update profile fields: `name`, `jobTitle`, `company`.
*   User can change password (with current password verification).
*   All protected endpoints require a valid access token.
*   Tokens are securely stored on mobile (Keychain/Keystore) and refreshed when expired.
*   Clear error messages and validation for invalid inputs.

---

## 3. Personas & User Stories

### Persona: “Regular User”
*   As a user, I want to log in so I can access my profile.
*   As a user, I want to view my profile so I can see my personal info.
*   As a user, I want to update my profile (`name`/`jabatan`/`company`) so my info stays current.
*   As a user, I want to change my password to keep my account secure.

### Non-Functional Stories
*   As a user, I want the app to be responsive and reliable (99% success for standard flows).
*   As a user, I want my data secured in transit (HTTPS) and at rest (hashed passwords, minimal PII).

---

## 4. System Architecture (High Level)

`Mobile App` ⇄ `Express API` ⇄ `MySQL Database`

*   Mobile stores tokens in secure storage, calls API with `Authorization: Bearer <accessToken>`.
*   Backend verifies access token, issues and rotates refresh tokens.
*   MySQL Database stores users (hashed passwords, profile fields) and token version for refresh invalidation.

---

## 5. Data Model (Relational)

### Table: `users`

| Column                | Type          | Constraints                        |
| --------------------- | ------------- | ---------------------------------- |
| `id`                  | UUID          | PK (generated by DB)               |
| `email`               | VARCHAR(255)  | UNIQUE, NOT NULL, lowercased       |
| `password_hash`       | TEXT          | NOT NULL (bcrypt)                  |
| `name`                | VARCHAR(100)  | NOT NULL                           |
| `job_title`           | VARCHAR(100)  | NULLABLE (maps to “jabatan”)       |
| `company`             | VARCHAR(100)  | NULLABLE                           |
| `refresh_token_version` | INTEGER       | DEFAULT 0 (for invalidating tokens)|
| `created_at`          | TIMESTAMPTZ   | DEFAULT now()                      |
| `updated_at`          | TIMESTAMPTZ   | DEFAULT now()                      |
| `last_login_at`       | TIMESTAMPTZ   | NULLABLE                           |

**Domain mapping:** `job_title` ⇄ jabatan, API key `jobTitle`.

---

## 6. API Contract

**Base URL:** `https://api.example.com/v1`

### 6.1 Auth

#### `POST /auth/login`
*   **Body**
    ```json
    {
      "email": "user@example.com",
      "password": "P@ssw0rd!"
    }
    ```
*   **200 OK**
    ```json
    {
      "accessToken": "<jwt>",
      "refreshToken": "<jwt>",
      "user": {
        "id": "1b2e...",
        "email": "user@example.com",
        "name": "Tio Misbaqul Irawan",
        "jobTitle": "Mobile Developer",
        "company": "BPJS Ketenagakerjaan"
      }
    }
    ```
*   **401 Unauthorized**
    ```json
    {
      "code": "AUTH_INVALID_CREDENTIALS",
      "message": "Invalid email or password"
    }
    ```

#### `POST /auth/refresh`
*   **Header:** (optional) `Authorization: Bearer <refreshToken>` or in body
*   **Body**
    ```json
    { "refreshToken": "<jwt>" }
    ```
*   **200 OK**
    ```json
    { "accessToken": "<newAccess>", "refreshToken": "<newRefresh>" }
    ```
*   **401/403:** Invalid or expired refresh token.

#### `POST /auth/logout`
*   **Header:** `Authorization: Bearer <accessToken>`
*   **Body:** empty
*   **200 OK**
    ```json
    { "success": true }
    ```
*   **Implementation:** Increment `refresh_token_version` to invalidate outstanding refresh tokens for the user.

---

### 6.2 Profile

#### `GET /me`
*   **Header:** `Authorization: Bearer <accessToken>`
*   **200 OK**
    ```json
    {
      "id": "1b2e...",
      "email": "user@example.com",
      "name": "Tio Misbaqul Irawan",
      "jobTitle": "Mobile Developer",
      "company": "BPJS Ketenagakerjaan"
    }
    ```

#### `PUT /me`
*   **Header:** `Authorization: Bearer <accessToken>`
*   **Body** (all fields optional but must pass validation)
    ```json
    {
      "name": "Tio Irawan",
      "jobTitle": "Flutter Developer",
      "company": "ICON+"
    }
    ```
*   **200 OK**
    ```json
    {
      "id": "1b2e...",
      "email": "user@example.com",
      "name": "Tio Irawan",
      "jobTitle": "Flutter Developer",
      "company": "ICON+"
    }
    ```
*   **400 Bad Request** (validation)
    ```json
    {
      "code": "PROFILE_VALIDATION_ERROR",
      "message": "Validation failed",
      "details": { "name": "Name is required" }
    }
    ```

#### `POST /me/change-password`
*   **Header:** `Authorization: Bearer <accessToken>`
*   **Body**
    ```json
    {
      "currentPassword": "oldpass",
      "newPassword": "NewPass#2025"
    }
    ```
*   **200 OK**
    ```json
    { "success": true }
    ```
*   **400/401**
    ```json
    { "code": "PASSWORD_INCORRECT", "message": "Current password is incorrect" }
    ```

---

## 7. Validation Rules
*   **Email:** required, valid format, lowercased, max 255.
*   **Password:** min 8 chars, at least 1 letter & 1 number; rate-limit login attempts.
*   **name:** required, 1–100 chars.
*   **jobTitle:** optional, 1–100 chars when provided.
*   **company:** optional, 1–100 chars when provided.

---

## 8. Security & Compliance
*   **Password Hashing:** `bcrypt` (cost 10–12).
*   **JWT:** `HS256` with `JWT_SECRET` (min 32 bytes).
*   **Access Token TTL:** 15 minutes.
*   **Refresh Token TTL:** 7 days.
*   **Refresh token payload** includes `sub`, `tokenVersion`.
*   **Transport:** HTTPS only; CORS restricted to mobile scheme or dev origin.
*   **Storage (mobile):** store tokens in secure storage (`Keychain`/`Keystore`). Never log secrets.
*   **Rate Limiting:** `/auth/login` (e.g., 5 req/min/IP) + basic brute-force protections.
*   **Audit:** update `last_login_at` on successful login.

---

## 9. Error Model

Standard error envelope:
```json
{
  "code": "<UPPER_SNAKE_CODE>",
  "message": "Human readable explanation",
  "details": { "field": "reason" }
}
```
**Common codes:** `AUTH_INVALID_CREDENTIALS`, `AUTH_TOKEN_EXPIRED`, `AUTH_FORBIDDEN`, `PROFILE_VALIDATION_ERROR`, `PASSWORD_INCORRECT`, `INTERNAL_ERROR`.

---

## 10. Mobile Flows & UX (minimal)
1.  **Login Screen**
    *   Fields: email, password; button: Login.
    *   On success: store tokens → navigate to Profile.
    *   On failure: show error from API.
2.  **Profile Screen**
    *   Display: name, jobTitle, company, email (read-only).
    *   Actions: Edit Profile, Change Password, Logout.
3.  **Edit Profile Screen**
    *   Inputs: name (required), jobTitle (optional), company (optional).
    *   Save → `PUT /me` → update local state.
4.  **Change Password Screen**
    *   Inputs: currentPassword, newPassword.
    *   Submit → `POST /me/change-password`.
5.  **Token Refresh Handling**
    *   If access token 401/expired: call `/auth/refresh` transparently.
    *   If refresh fails: force logout.

---

## 11. Acceptance Criteria (Gherkin-style)

### Login
*   **Given** a registered user with correct password,
*   **When** they submit email & password,
*   **Then** they receive access & refresh tokens and can access `/me`.

### View Profile
*   **Given** a valid access token,
*   **When** calling `GET /me`,
*   **Then** API returns profile with name, jobTitle, company, email.

### Update Profile
*   **Given** a valid access token,
*   **When** sending `PUT /me` with valid fields,
*   **Then** the profile is updated and returned.
*   **And** invalid fields return `PROFILE_VALIDATION_ERROR` with details.

### Change Password
*   **Given** a valid access token,
*   **When** posting correct `currentPassword` and strong `newPassword`,
*   **Then** API returns `{ "success": true }` and user can log in with the new password.
*   **And** wrong `currentPassword` returns `PASSWORD_INCORRECT`.

---

## 12. Backend Implementation Notes (Express)

### Structure
```
src/
  app.ts (express, middlewares, routes)
  server.ts (bootstrap)
  config/
  modules/
    auth/
      controller.ts, service.ts, router.ts
    users/
      controller.ts, service.ts, router.ts, repo.ts
  middlewares/
    authGuard.ts, errorHandler.ts, rateLimit.ts
  utils/
    jwt.ts, bcrypt.ts, validator.ts
```

### Dependencies
`express`, `zod`/`yup` (validation), `jsonwebtoken`, `bcrypt`, `pg` (or `prisma`/`sequelize`), `helmet`, `cors`, `express-rate-limit`.

### Env Vars
```ini
PORT=8080
DATABASE_URL=postgres://user:pass@host:5432/db
JWT_SECRET=supersecret_32chars_min
ACCESS_TOKEN_TTL=15m
REFRESH_TOKEN_TTL=7d
CORS_ALLOWED_ORIGINS=*
```

### Migrations/Seeds
Create `users` table; seed one user for testing.

### Error Handling
Centralized `errorHandler` mapping known errors to the error model.

---

## 13. Testing Plan
*   **Unit:** services (auth, users), validators.
*   **Integration:** API tests for `/auth/login`, `/auth/refresh`, `/me`, `PUT /me`, `/me/change-password`.
*   **Manual:** Postman collection covering happy paths & common failures.

---

## 14. Deployment & DevOps (Minimal)
*   **Dev:** `docker-compose` with Postgres; `nodemon` for hot reload.
*   **Prod:** container image (Node 20-alpine) + managed Postgres (e.g., Railway/Render). Enable HTTPS via reverse proxy or platform settings.
*   **Observability:** basic request logging (`morgan`) and error logs; health check endpoint `/health` returning `{ "status": "ok" }`.

---

## 15. Risks & Mitigations
*   **Token leakage** → use secure storage; rotate refresh tokens; short access TTL.
*   **Weak passwords** → enforce policy & rate limit.
*   **CORS misconfig** → restrict origins in production.
*   **Time constraints** → ship MVP first; extras as stretch goals.

---

## 16. Stretch Goals (if time permits)
*   Registration and Forgot Password (email OTP)
*   Session list & revoke sessions
*   Avatar upload (S3/Cloud Storage)
*   Audit log of profile changes

---

## 17. API Examples (cURL)

### Login
```bash
curl -X POST https://api.example.com/v1/auth/login \
 -H 'Content-Type: application/json' \
 -d '{"email":"user@example.com","password":"P@ssw0rd!"}'
```

### Get Profile
```bash
curl -H 'Authorization: Bearer <access>' https://api.example.com/v1/me
```

### Update Profile
```bash
curl -X PUT https://api.example.com/v1/me \
 -H 'Authorization: Bearer <access>' \
 -H 'Content-Type: application/json' \
 -d '{"name":"Tio Irawan","jobTitle":"Flutter Dev","company":"ICON+"}'
```

### Change Password
```bash
curl -X POST https://api.example.com/v1/me/change-password \
 -H 'Authorization: Bearer <access>' \
 -H 'Content-Type: application/json' \
 -d '{"currentPassword":"old","newPassword":"NewPass#2025"}'
```

---

## 18. Glossary
*   **jabatan** → job title (`jobTitle`)
*   **access token** → short-lived JWT for API access
*   **refresh token** → long-lived JWT for obtaining new access tokens
*   